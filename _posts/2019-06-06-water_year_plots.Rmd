---
title: "Calculating Water Year and Moving Mean"
author: "Bill Rice"
date: "6/6/2019"
output: html_document
---

## Estimating Annual Precipitation and Moving Averages

In the United States of America the common definition of a water year among hydrologists is from October 1st to September 30th. This script walks you through pulling data from the NOAA Climate Data search tool and building a graph showing annual precipitation over each water year in the dataset.

Start by visiting [NOAA's Climate Data Search Tool](https://www.ncdc.noaa.gov/cdo-web/search?datasetid=GHCND) and downloading a CSV formated file containing daily precipitation.

# Load the necessary libraries

```{r}

library(ggplot2)
library(zoo)
library(tools)
```

# Write a function to add a water year column (for use later in the script)
```{r}
wtr_yr <- function(dates, start_month=9) {
  # Convert dates into POSIXlt
  dates.posix = as.POSIXlt(dates)
  # Year offset
  offset = ifelse(dates.posix$mon >= start_month - 1, 1, 0)
  # Water year
  adj.year = dates.posix$year + 1900 + offset
  # Return the water year
  adj.year
}
```

# Load your data file (downloaded from Noaa)
```{r}
noaa_stations <- read.csv("~/GitHub/butte_hydro_budget/input/noaa_stations.csv", header=TRUE)
```

# Choose what stations you want to use (useful if you downloaded multiple stations)
```{r}
noaa_station <- subset(noaa_stations, noaa_stations$STATION == "USC00045941")
```

# Ensure the dates are stored as dates by using as.Date()
```{r}
noaa_station$DATE <- as.Date(noaa_station$DATE)
```

# Add a column for water year 
```{r}
noaa_station$water_year <- wtr_yr(noaa_station$DATE)
```
#Add months (this isn't used in this example)
```{r}
noaa_station$month <- months(noaa_station$DATE)
```
#Calculate annual sums by water year
```{r}
noaa_station <- aggregate( PRCP ~ water_year , noaa_station , sum )
```

#Calculate precitation in inches if data was downloaded in milimeters
```{r}
noaa_station$PRCP_in <- noaa_station$PRCP/25.4 #Multiply by 25.4 to make mm into inches (if desired)
```

# Remove na values
```{r}
noaa_station <- na.omit(noaa_station)
```

# Make a plot showing a 20 year rolling mean
```{r}
ggplot(noaa_station, aes(x = water_year, y = PRCP_in)) +
  geom_bar(stat = "identity", color="black", fill="lightsteelblue1")+
  
  labs(title = "Annual Water Year Precipitation -",
       subtitle = toTitleCase(tolower(as.character(subset(noaa_stations, noaa_stations$STATION == "USC00045941")$NAME[1]))),
       y = "Annual Precipitation in Inches",
       x = "Water Year (October 1 to September 30)") + 
  geom_path(aes(y=rollmean(PRCP_in, 
                           k=20, 
                           na.pad = TRUE)), na.rm=TRUE)+
  theme_minimal()
```